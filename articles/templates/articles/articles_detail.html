{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% load static %}

{% block css %}
<link rel="stylesheet" href="/static/css/articles_detail.css">
<link rel="stylesheet" href="/static/css/search.css">
<link rel="stylesheet" href="/static/css/articles_create.css">
<link rel="stylesheet" href="/static/css/btn.css">
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
  integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript" src="stopwatch.js"></script>


{% endblock css %}

<meta charset="UTF-8">
<title>StopWatch</title>

{% block content %}

<div style="display:flex; justify-content:center; align-items:center;">
  <div
    style="background-color:rgb(239, 239, 239, 0.8); box-shadow:5px 5px 30px 5px #363062; border-radius:15px; width:60vw; min-width: 350px;">
    <div>
      <h3 class="mt-3" align="center" style="font-weight:lighter; font-size:20px; padding-top:2rem;">오늘은 어떠신가요?</h3>

    </div>

    <div class="row my-2">
      <div class="col-lg-7 m-2">
        <div class="d-plex position-sticky bg-white p-5 rounded-5 review-card" style="top: 10rem;">
          <div class="mb-3 d-flex justify-content-between align-items-center">
          </div>
          <div class="mb-3 d-flex justify-content-between align-items-center" style="flex-direction: column;">
            <h1 class="text-start fs-6 mb-0 fw-bold font-space">#익명#</h1>



            {% if articles.picture %}

            <div class="d-flex justify-content-center">
              <img src="{{ articles.picture.url }}" alt="{{ articles.picture }}" class="container px-0"
                style="width: 480px; height: 360px;">
            </div>
            {% else %}
            <div class="d-flex justify-content-center">
              <img src="" alt="">
            </div>
            {% endif %}
            <div class="fs-6 font-space">{{ articles.content }}</div>
            {{ articles.feelings }}

            {% if request.user == articles.user %}
            <form action="{% url 'articles:articles_delete' articles.pk %}" method="POST">
              {% csrf_token %}
              <div class="text-end">
                <a href="{% url 'articles:articles_update' articles.pk %}" class="btn articles-update-btn rounded-0"
                  method="POST">수정</a>
                <input class="btn articles-delete-btn rounded-0" type="submit" value="삭제">
              </div>
            </form>
            {% endif %}
            {% if request.user != articles.user %}
            <a href="{% url 'accounts:message_create' articles.user.pk articles.pk %}">메시지 보내기</a>
            <a href="" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal">게시글 신고하기</a>
            {% endif %}
          </div>
        </div>
        <!-- 게시글 신고 Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">신고하기</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form action="{% url 'articles:articles_declaration' articles.pk %}" method="POST">
                  {% csrf_token %}
                  {% bootstrap_form articles_declaration_form %}
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">신고하기</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div id="player"></div>
        <!--스톱워치 음악재생 end-->

      </div>
      <div class="col-12 col-lg-4">
        <div class="d-plex position-sticky bg-white p-5 rounded-5 review-card" style="top: 10rem;">
          <div class="mb-3 d-flex justify-content-between align-items-center" style="flex-direction: column;">
            <!--썸네일 부분-->
            <img src="{{ articles.song.song_thumbnail }}" style="height: 100px; " />

            <!--음악재생,스톱워치-->
            <div id='box' class="box">
              <div id='timerBox' class="timerBox">
                <div id="time" class="time">00:00:00</div>
              </div>
              <div class="btnBox">
                <i id="play-button" class="fa fa-play" aria-hidden="true"></i>
                <i id="pause-button" class="fa fa-pause" aria-hidden="true"></i>
                <i id="stop-button" class="fa fa-stop" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
        <br>
        <div class="d-plex position-sticky bg-white p-5 rounded-5 review-card" style="top: 10rem;">

          {% comment %} 댓글 작성 {% endcomment %}
          {% if request.user.is_authenticated %}
          <div class="col-12  p-5">
            <div class="d-flex flex-column justify-content-start mt-3" style="z-index: 2;">
              <form id='comment-form' data-detail-id="{{ articles.pk }}">
                {% csrf_token %}
                {% bootstrap_form comment_form %}
                <div class="text-end">
                  <button class="btn btn-dark rounded-0">작성</button>
                  <input type="hidden" name="parent" value=0>
                </div>
              </form>
              <div id="comments" class="my-5">
                {% endif %}
                <!-- 반복문으로 댓글 뽑음 -->
                {% for comment in comments %}
                {% if comment.parent_id == None %}
                <div class="container" id='com{{ comment.pk }}'>
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                      <span class="text-muted ms-2 font-space">#익명#</span>
                    </div>
                    <!-- 댓글 내용 상세 보기 -->
                    <a class="mb-0 mx-3 text-truncate font-space text-decoration-none text-black" data-bs-toggle="modal"
                      data-bs-target="#commentDetailModal{{ comment.pk }}">{{ comment.content
                      }}</a>
                    <!-- 댓글 내용 상세 모달 -->
                    <div class="modal fade shadow-lg" id="commentDetailModal{{ comment.pk }}" tabindex="-1"
                      aria-labelledby="modalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered rounded-0">
                        <div class="modal-content p-3 rounded-0">
                          <div class="text-end">
                            <button type="button" class="btn-close" style="width: 5px; height:5px;"
                              data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body text-start">
                            <pre class="mb-0 font-space" id="modalLabel"
                              style="font-size: 16px;">{{ comment.content }}</pre>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class='comments_set'>
                      {% if request.user == comment.user %}
                      <form id='parentform' data-articles-id='{{ articles.pk }}' data-comment-id='{{ comment.pk }}'
                        action="{% url 'articles:comment_delete' articles.pk comment.pk %}" method="POST">
                        {% csrf_token %}
                        <input class="btn btn-outline-dark rounded-0" type="submit" value="삭제">
                      </form>
                      {% endif %}
                      <a href="" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal2">댓글 신고하기</a>
                    </div>
                  </div>
                  <div class='d-flex align-items-center'>
                    <hr class="border border-dark border-1 opacity-50 d-block me-2" width="25px;">
                    <a href="" class='text-decoration-none text-dark recomBox'><span data-box-id={{comment.id}}
                        class='text-muted'>답글 보기</span></a>
                  </div>

                  <!-- 댓글 신고 Modal -->
                  <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel2"
                    aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h1 class="modal-title fs-5" id="exampleModalLabel2">신고하기</h1>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <form action="{% url 'articles:comment_declaration' articles.pk comment.pk %}" method="POST">
                            {% csrf_token %}
                            {% bootstrap_form comment_declaration_form %}
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <button type="submit" class="btn btn-danger">신고하기</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>

                  {% comment %} 대댓글 출력 {% endcomment %}

                  <div id='recom_set{{comment.id}}' style='display: none;' class='py-2'>
                    {% for recom in comments %}
                    {% if comment.id == recom.parent_id %}
                    <div id='com{{ recom.pk }}' class="border my-2 p-2">
                      <div class="d-flex align-items-center">
                        <p class="mb-0 ms-2 me-auto text-muted">#익명#</p>
                      </div>
                      <div class="p-3">{{ recom.content }}</div>
                      <div class="comments_set text-end">
                        {% if recom.user == request.user %}
                        <form id='parentform' data-articles-id='{{ articles.pk }}' data-comment-id='{{ recom.id }}'
                          action="{% url 'articles:comment_delete' articles.pk recom.pk %}" method="POST">
                          {% csrf_token %}
                          <input class="btn btn-outline-dark rounded-0" type="submit" value="삭제">
                        </form>
                        {% endif %}
                      </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                  </div>
                  {% comment %} 대댓글이 작성되는곳 {% endcomment %}
                  {% if comment.user != request.user %}
                  <a href="" data-comment-id={{ comment.id }}
                    class='recomment_btn text-decoration-none text-dark text-muted'>[답글]</a>
                  <div id='recom{{ comment.id }}' style='display:none;'>
                    <form class="parentForm my-2" data-articles-id="{{ articles.pk }}"
                      data-comment-id="{{ comment.id}}">
                      {% csrf_token %}
                      {% bootstrap_form comment_form %}
                      <input name='parent' type='hidden' value="{{ comment.pk }}">
                      <div class="text-end">
                        <input type="submit" value="작성" class="btn btn-non btn-outline-dark rounded-0">
                      </div>
                    </form>
                  </div>
                  {% endif %}
                  <hr>
                  <br>
                </div>
                {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const commentForm = document.querySelector('#comment-form')
    //console.log(commentForm)
    const csrftoken = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value
    commentForm
      .addEventListener('submit', function (event) {
        event.preventDefault();
        axios({
          method: 'POST',
          url: `/articles/${event.target.dataset.detailId}/articles_detail/comments/`,
          headers: {
            'X-CSRFToken': csrftoken
          },
          data: new FormData(commentForm)
        })
          .then(response => {
            //console.log(data)
            //console.log(response.data.review_pk)


            const comments = document.querySelector('#comments')
            comments.insertAdjacentHTML('beforeend', `
              <div class="container" id="com${response.data.comment_pk}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div class="d-flex align-items-center">
                    <span class="text-muted ms-2 font-space">${response.data.userName}</span>
                  </div>
                  <a class="mb-0 mx-3 text-truncate font-space text-decoration-none text-black" data-bs-toggle="modal" data-bs-target="#commentDetailModal${response.data.comment_pk}">${response.data.content}</a>
                  <div class="modal fade shadow-lg" id="commentDetailModal${response.data.comment_pk}" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered rounded-0">
                      <div class="modal-content p-3 rounded-0">
                        <div class="text-end">
                          <button type="button" class="btn-close" style="width: 5px; height:5px;" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-start">
                          <pre class="mb-0 font-space" id="modalLabel" style="font-size: 16px;">${response.data.content}</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class='comments_set'>
                    <form data-articles-id='${response.data.articles_pk}' data-comment-id='${response.data.comment_pk}' action="http://127.0.0.1:8000/articles/${response.data.articles_pk}/articles_detail/comments/${response.data.comment_pk}/comment_delete/" method="POST">
                      {% csrf_token %}
                      <input class="btn btn-outline-dark rounded-0" type="submit" value="삭제">
                    </form>
                  </div>
                </div>
                <div class='d-flex align-items-center'>
                  <hr class="border border-dark border-1 opacity-50 d-block me-2" width="25px;">
                  <a href="" class='text-decoration-none text-dark recomBox'><span data-box-id=${response.data.comment_pk} class='text-muted'>답글 보기</span></a>
                </div>
                <hr>
                <br>
              </div>`);


            result = document.querySelector(`#com${response.data.comment_pk}`)
            //console.log(result)
            result.addEventListener('submit', event => {
              event.preventDefault()
              //console.log(event.target.dataset)
              const articles_pk = event.target.dataset.articlesId
              const comment_pk = event
                .target
                .dataset
                .commentId
              axios({
                method: 'post',
                url: `/articles/${articles_pk}/articles_detail/comments/${comment_pk}/comment_delete/`,
                headers: {
                  'X-CSRFToken': csrftoken
                }
              })
                .then(response => {
                  const deldiv = document.getElementById(`com${comment_pk}`)
                  console.log(deldiv)
                  deldiv.remove();
                })

            })
            commentForm.reset()
          })
          .catch(error => {
            console.log(error.response)
            if (error.response.status === 403) {
              alert("로그인을 먼저 해주세요!")
              window.location.href = '{% url "accounts:login" %}';
            }
          })
      })
    //삭제를 해보자아
    const commentDel = document.querySelectorAll('.comments_set')
    commentDel.forEach(form => {
      form.addEventListener('submit', event => {
        event.preventDefault()
        //console.log(event.target.dataset)
        const articles_pk = event.target.dataset.articlesId
        const comment_pk = event.target.dataset.commentId
        axios({
          method: 'post',
          url: `/articles/${articles_pk}/articles_detail/comments/${comment_pk}/comment_delete/`,
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
          .then(response => {
            const deldiv = document.getElementById(`com${comment_pk}`)
            console.log(deldiv)
            if (deldiv === null) {

              console.log(1)
            }
            deldiv.remove();

          })
          .catch(error => {
            //console.log(deldiv)
          })
      })
    })


    // 대댓..가즈아~
    const parentForm = document.querySelectorAll('.parentForm')

    parentForm.forEach(form => {
      form.addEventListener('submit', event => {
        event.preventDefault();
        const articles_pk = event.target.dataset.articlesId
        const comment_pk = event.target.dataset.commentId
        console.log(event.target.dataset)
        //console.log(review_pk)
        //console.log(comment_pk)
        console.log(event.target.dataset)
        axios({
          method: 'post',
          url: `/articles/${articles_pk}/articles_detail/comments/`,
          headers: {
            'X-CSRFToken': csrftoken
          },
          data: new FormData(form)
        })
          .then(response => {
            console.log(response.data)
            const recomSet = document.querySelector(`#recom_set${comment_pk}`)
            const data = response.data

            recomSet.insertAdjacentHTML('beforeend', `
            <div id='com${response.data.comment_pk}' class="border my-2 p-2">
              <div class="d-flex align-items-center">
                <p class="mb-0 ms-2 me-auto text-muted">${response.data.userName}</p>
              </div>
              <p class="p-3">${response.data.content}</p>
              <div class="comments_set text-end">           
                <form id='parentform' data-articles-id='${articles_pk}' data-comment-id='${response.data.comment_pk}' action="http://127.0.0.1:8000/articles/${articles_pk}/articles_detail/comments/${response.data.comment_pk}/comment_delete/" method="POST">
                  {% csrf_token %}
                  <input class="btn btn-outline-dark rounded-0" type="submit" value="삭제">
                </form>
              </div>
            </div>
            `)



            result = document.querySelector(`#com${response.data.comment_pk}`)
            result.addEventListener('submit', event => {
              event.preventDefault()
              //console.log(event.target.dataset)
              const articles_pk = event.target.dataset.articlesId
              const comment_pk = event
                .target
                .dataset
                .commentId
              axios({
                method: 'post',
                url: `/articles/${articles_pk}/articles_detail/comments/${comment_pk}/comment_delete/`,
                headers: {
                  'X-CSRFToken': csrftoken
                }
              })
                .then(response => {
                  const deldiv = document.getElementById(`com${comment_pk}`)
                  console.log(deldiv)
                  deldiv.remove();
                })
            })
            commentForm.reset()
          })
          .catch(error => {
            console.log(error.response)
            if (error.response.status === 403) {
              alert("로그인을 먼저 해주세요!")
              window.location.href = '{% url "accounts:login" %}';
            }
          })
        form.reset()
      })
    })
    //답글 누르면 폼나오게
    //console.log(document.getElementById('recom4').style.diplay="block;") // 아이디로 접근
    const recomment_btn = document.querySelectorAll('.recomment_btn')
    recomment_btn.forEach(form => {
      form.addEventListener('click', event => {
        event.preventDefault();
        if (document.getElementById(`recom${event.target.dataset.commentId}`).style.cssText === "display: none;") {
          document.getElementById(`recom${event.target.dataset.commentId}`).style.cssText = 'block';
          //console.log(document.getElementById(`recom${event.target.dataset.commentId}`).style)
        } else {
          console.log(document.getElementById(`recom${event.target.dataset.commentId}`).style.cssText)
          document.getElementById(`recom${event.target.dataset.commentId}`).style.cssText = 'display: none;';
        }

      })
    })

    const recomBox = document.querySelectorAll('.recomBox')
    recomBox.forEach(form => {
      form.addEventListener('click', event => {
        event.preventDefault();
        toggle_ = document.getElementById(`recom_set${event.target.dataset.boxId}`)
        //console.log(toggle_.style.cssText)
        if (toggle_.style.cssText === "display: none;") {
          toggle_.style.cssText = 'block';
          //console.log(toggle_.style)
        } else {
          console.log(toggle_.style.cssText)
          toggle_.style.cssText = 'display: none;';
        }
        //console.log(event.target.dataset.boxId)
      })
    })

  </script>



  <!--음악재생 스크립트!-->

  <!-- 1. The < iframe > (and video player) will replace this < div > tag. -->



  <script>

    // 2. This code loads the IFrame Player API code asynchronously.

    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";

    var firstScriptTag = document.getElementsByTagName('script')[0];

    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);



    // 3. This function creates an <iframe> (and YouTube player)

    //    after the API code downloads.

    var player;

    function onYouTubeIframeAPIReady() {

      player = new YT.Player('player', {

        height: '0',

        width: '0',

        videoId: '{{ articles.song.song_url }}',

        playerVars: { 'controls': 2, 'autohide': 1, 'playlist': '{{ articles.song.song_url }}', 'loop': 1, 'start': '{{ articles.music_start }}' },

        events: {

          'onReady': onPlayerReady,

          'onStateChange': onPlayerStateChange

        }

      });

    }



    // 4. The API will call this function when the video player is ready.


    function onPlayerReady(event) {
      var playButton = document.getElementById("play-button");
      playButton.addEventListener("click", function () {
        event.target.setVolume(10);
        event.target.getVolume(10);
        player.playVideo(10);
      });
      var pauseButton = document.getElementById("pause-button");
      pauseButton.addEventListener("click", function () {
        event.target.setVolume(10);
        event.target.getVolume(10);
        player.pauseVideo(10);
      });
      var stopButton = document.getElementById("stop-button");
      stopButton.addEventListener("click", function () {
        event.target.setVolume(10);
        event.target.getVolume(10);
        player.stopVideo(10);
      });
    }



    // 5. The API calls this function when the player's state changes.

    //    The function indicates that when playing a video (state=1),

    //    the player should play for six seconds and then stop.

    var done = false;

    function onPlayerStateChange(event) {

      if (event.data == YT.PlayerState.PLAYING && !done) {

        done = true;

      }

    }

    function stopVideo() {
      event.target.setVolume(10);
      event.target.getVolume(10);
      player.stopVideo(10);

    }

  </script>
  <!--음악재생 스크립트 마지막!-->

  <!--스톱워치-->

  <script>
    var time = 0;
    var starFlag = true;
    $(document).ready(function () {
      buttonEvt();
    });

    function init() {
      document.getElementById("time").innerHTML = "00:00:00";
    }

    function buttonEvt() {
      var hour = 0;
      var min = 0;
      var sec = 0;
      var timer;

      // start btn
      $("#play-button").click(function () {

        if (starFlag) {
          $(".fa").css("color", "#FAED7D")
          this.style.color = "#4C4C4C";
          starFlag = false;

          if (time == 0) {
            init();
          }

          timer = setInterval(function () {
            time++;

            min = Math.floor(time / 60);
            hour = Math.floor(min / 60);
            sec = time % 60;
            min = min % 60;

            var th = hour;
            var tm = min;
            var ts = sec;
            if (th < 10) {
              th = "0" + hour;
            }
            if (tm < 10) {
              tm = "0" + min;
            }
            if (ts < 10) {
              ts = "0" + sec;
            }

            document.getElementById("time").innerHTML = th + ":" + tm + ":" + ts;
          }, 1000);
        }
      });

      // pause btn
      $("#pause-button").click(function () {
        if (time != 0) {
          $(".fa").css("color", "#FAED7D")
          this.style.color = "#4C4C4C";
          clearInterval(timer);
          starFlag = true;
        }
      });

      // stop btn
      $("#stop-button").click(function () {
        if (time != 0) {
          $(".fa").css("color", "#FAED7D")
          this.style.color = "#4C4C4C";
          clearInterval(timer);
          starFlag = true;
          time = 0;
          init();
        }
      });
    }

  </script>

  <!--스톱워치 끝-->

</div>


{% endblock content %}