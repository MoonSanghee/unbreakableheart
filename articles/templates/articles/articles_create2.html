{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}
<div class="container" style="padding:5rem;">
  <h1 class="text-start fs-5 mb-4 fw-bold font-space">글 작성</h1>
  <form action="" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    {% bootstrap_form articles_form %}
    <input id="search_input" class="reviewcreate-userinfo" name="song" type="search" placeholder="클릭 후 노래를 검색하세요"
    aria-label="Search" autocomplete="off">
    <div class="search-off search-div " id="search_box"></div>
    <div>원하는 노래가 없다면
      <a class="text-decoration-none" href="{% url 'music:search' %}" onclick="window.open(this.href, '_blank', 'width=800, height=600, toolbars=no, scrollbars=yes'); return false;">노래 추가</a>
    </div>
    {% bootstrap_button button_type="submit" content="제출"%}
  </form>
  <form id="search_form" action="{% url 'articles:song_search' %}" class="d-flex hidden" role="search"></form>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const search_input = document.querySelector('#search_input');
  const search_box = document.querySelector('#search_box');
  const input = document.createElement('input');
  const side = document.querySelector('#side');
  const box_open = false;

  search_input.addEventListener('click', function (event) {
    console.log("검색클릭");
    search_box.classList.remove('search-off');
    search_box.classList.add('search-on');
    const box_open = true;
    console.log("검색 열림");

  });

  document.addEventListener('click', function (e) {
    console.log(e.target)
    console.log(search_box.id)
    if (box_open === true) 
    ;
    {
      if (e.target !== search_input) {
        search_box.classList.remove('search-on');
        search_box.classList.add('search-off');
        console.log("검색디브 닫힘")
      }
    }
  });
  // 노래검색
  window.onload = function () {
    search_input.onkeyup = function () {
      console.log("검색중")
      axios({
        method: 'get', 
        url: `/articles/song_search/?search=${search_input.value}`})
        .then(response => {
        const search_box = document.querySelector('#search_box');
        const song_list = response.data.song_list;
        search_box.textContent = "";
        for (let i = 0; i < song_list.length; i++) {
          search_box.insertAdjacentHTML('beforeend', `
        <div onclick="add_song()" data-name-id="${song_list[i].name}"  data-song_name-id="${song_list[i].id}"  id="song_${song_list[i].id}">
        <hr class='m-0'>
          <div class='search-box'  data-name-id="${song_list[i].name}">
            <div class="search-box-mini">  
              <p onclick="add_song()" data-name-id="${song_list[i].name}" >${song_list[i].name}</p> 
            </div>
          </div>
        </div>
        `);
        }
      })
    }
  }

  const add_song = (e) => {
    const add_id = document.querySelector(`#song_${event.target.dataset.songId}`)
    search_input.value = `${event.target.dataset.nameId}`
      console.log(`${event.target.dataset.nameId}`)
  }
</script>
{% endblock content %}